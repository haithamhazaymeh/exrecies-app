name: Build iOS IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        working-directory: workout_tracker
        run: |
          flutter pub get
          cd ios && pod install --repo-update

      - name: Build iOS App
        working-directory: workout_tracker
        run: |
          # Use flutter command that creates the app properly
          flutter build ios --release --no-codesign
          
          # Find what was built
          echo "=== Searching for .app bundles ==="
          find build -name "*.app" -type d 2>/dev/null || true
          find . -path "*/Release-iphoneos/*.app" -type d 2>/dev/null || true

      - name: Create IPA Package
        working-directory: workout_tracker
        run: |
          # Look in the standard Flutter output location
          APP_PATH="build/ios/iphoneos/Runner.app"
          
          if [ -d "$APP_PATH" ]; then
            echo "Found app at: $APP_PATH"
            du -sh "$APP_PATH"
            ls -la "$APP_PATH"
            
            # Check for binary
            if [ -f "$APP_PATH/Runner" ]; then
              echo "✓ Binary exists"
              file "$APP_PATH/Runner"
              
              # Create IPA
              mkdir -p output/Payload
              cp -r "$APP_PATH" output/Payload/
              cd output
              zip -r workout_tracker.ipa Payload
              ls -lh workout_tracker.ipa
              echo "✓ IPA created!"
            else
              echo "✗ No binary in app bundle"
              ls -laR "$APP_PATH" | head -50
            fi
          else
            echo "App not found at expected path"
            echo "Searching everywhere..."
            find build -name "Runner.app" -type d 2>/dev/null
            find ios -name "Runner.app" -type d 2>/dev/null
            
            # Try alternative paths
            ALT_PATH=$(find build -name "Runner.app" -type d 2>/dev/null | head -1)
            if [ -n "$ALT_PATH" ] && [ -f "$ALT_PATH/Runner" ]; then
              echo "Found at: $ALT_PATH"
              mkdir -p output/Payload
              cp -r "$ALT_PATH" output/Payload/
              cd output
              zip -r workout_tracker.ipa Payload
              ls -lh workout_tracker.ipa
            fi
          fi

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: workout-tracker-ipa
          path: workout_tracker/output/workout_tracker.ipa
          if-no-files-found: warn

      - name: Upload full build output (debug)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-build-output
          path: |
            workout_tracker/build/ios/
          if-no-files-found: warn
