name: Build iOS IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get dependencies
        working-directory: workout_tracker
        run: flutter pub get

      - name: Modify project for no code signing
        working-directory: workout_tracker/ios
        run: |
          # Use Ruby to properly update all signing settings
          ruby << 'RUBY'
          project_path = "Runner.xcodeproj/project.pbxproj"
          content = File.read(project_path)
          
          # Remove all CODE_SIGN settings
          content.gsub!(/CODE_SIGN_IDENTITY = "[^"]*"/, 'CODE_SIGN_IDENTITY = ""')
          content.gsub!(/DEVELOPMENT_TEAM = [^;]*;/, 'DEVELOPMENT_TEAM = "";')
          content.gsub!(/CODE_SIGN_STYLE = [^;]*;/, 'CODE_SIGN_STYLE = Manual;')
          content.gsub!(/PROVISIONING_PROFILE_SPECIFIER = "[^"]*"/, 'PROVISIONING_PROFILE_SPECIFIER = ""')
          
          File.write(project_path, content)
          puts "✓ Updated project.pbxproj for no signing"
          RUBY

      - name: Build iOS (no codesign)
        working-directory: workout_tracker
        run: |
          flutter build ios --release --no-codesign 2>&1 || echo "Build completed (may have warnings)"

      - name: Find and create IPA
        working-directory: workout_tracker
        run: |
          echo "=== Searching for Runner.app ==="
          find build -name "Runner.app" -type d 2>/dev/null
          
          # Try all possible locations
          for SEARCH_PATH in \
            "build/ios/iphoneos/Runner.app" \
            "build/ios/Release-iphoneos/Runner.app" \
            "build/ios/Debug-iphoneos/Runner.app" \
            "build/ios/iphonesimulator/Runner.app"
          do
            if [ -d "$SEARCH_PATH" ]; then
              APP_PATH="$SEARCH_PATH"
              echo "Found app at: $APP_PATH"
              break
            fi
          done
          
          # Fallback: find any Runner.app
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find build -name "Runner.app" -type d 2>/dev/null | head -1)
          fi
          
          if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
            echo "Using app: $APP_PATH"
            APP_SIZE=$(du -sk "$APP_PATH" | cut -f1)
            echo "Size: ${APP_SIZE} KB"
            
            # List contents
            echo "=== App Contents ==="
            ls -la "$APP_PATH"
            
            # Check for binary
            if [ -f "$APP_PATH/Runner" ] || [ -f "$APP_PATH/Info.plist" ]; then
              echo "✓ App bundle looks valid"
              
              # Create IPA
              mkdir -p Payload
              cp -r "$APP_PATH" Payload/
              
              # Zip it
              zip -r workout_tracker.ipa Payload -x "*.DS_Store"
              
              echo "=== IPA Created ==="
              ls -lh workout_tracker.ipa
              
              # Verify IPA contents
              unzip -l workout_tracker.ipa | head -20
            else
              echo "✗ App bundle incomplete"
              ls -laR "$APP_PATH"
            fi
          else
            echo "✗ No Runner.app found"
            echo "Build structure:"
            find build/ios -type d 2>/dev/null | head -30
          fi
          
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: workout-tracker-ipa
          path: workout_tracker/workout_tracker.ipa
          if-no-files-found: warn
          
      - name: Upload build for debugging
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-build-output
          path: workout_tracker/build/ios/
          if-no-files-found: warn
