name: Build iOS IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get dependencies
        working-directory: workout_tracker
        run: flutter pub get

      - name: Generate iOS project files
        working-directory: workout_tracker
        run: |
          flutter create --platforms=ios . || true
          flutter pub get

      - name: Modify project for no code signing
        working-directory: workout_tracker/ios
        run: |
          # Backup original project
          cp -r Runner.xcodeproj Runner.xcodeproj.backup
          
          # Use sed to update project settings
          sed -i '' 's/CODE_SIGN_IDENTITY = "Apple Development"/CODE_SIGN_IDENTITY = ""/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = ""/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer"/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = ""/g' Runner.xcodeproj/project.pbxproj
          
          # Add signing settings
          ruby << 'RUBY'
          project_path = "Runner.xcodeproj/project.pbxproj"
          content = File.read(project_path)
          
          # Replace all CODE_SIGN_IDENTITY values
          content.gsub!(/CODE_SIGN_IDENTITY = "[^"]*"/, 'CODE_SIGN_IDENTITY = ""')
          content.gsub!(/DEVELOPMENT_TEAM = [^;]*;/, 'DEVELOPMENT_TEAM = "";')
          content.gsub!(/CODE_SIGN_STYLE = [^;]*;/, 'CODE_SIGN_STYLE = Manual;')
          
          File.write(project_path, content)
          puts "Updated project.pbxproj"
          RUBY
          
          echo "Project modified successfully"

      - name: Build iOS binary only
        working-directory: workout_tracker
        run: |
          # Skip the AOT compilation issues by building framework
          flutter build ios --release --no-codesign 2>&1 || {
            echo "Release build failed, checking what was built..."
            find build -name "*.framework" -o -name "*.app" 2>/dev/null | head -20
          }

      - name: Check all build outputs
        working-directory: workout_tracker
        run: |
          echo "=== All iOS build products ==="
          find build/ios -type f -name "*.a" -o -name "*.dylib" -o -name "*.framework" 2>/dev/null | head -30
          
          echo "=== App bundles ==="
          find build -name "*.app" -type d 2>/dev/null
          
          echo "=== Directory structure ==="
          find build/ios -type d 2>/dev/null | head -40
          
      - name: Package what we have
        working-directory: workout_tracker
        run: |
          # Find any app bundle
          APP=$(find build -name "Runner.app" -type d 2>/dev/null | head -1)
          
          if [ -n "$APP" ] && [ -d "$APP" ]; then
            SIZE=$(du -sk "$APP" | cut -f1)
            echo "Found app: $APP (${SIZE}KB)"
            
            if [ "$SIZE" -gt 500 ]; then
              mkdir -p Payload
              cp -r "$APP" Payload/
              zip -r workout_tracker.ipa Payload
              ls -lh workout_tracker.ipa
            fi
          else
            echo "No valid app bundle found"
            # Create a zip of all iOS build products for analysis
            zip -r ios-build-products.zip build/ios/ 2>/dev/null || true
          fi
          
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: workout-tracker-ipa
          path: |
            workout_tracker/workout_tracker.ipa
            workout_tracker/ios-build-products.zip
          if-no-files-found: warn
          
      - name: Upload build directory
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-build-output
          path: workout_tracker/build/
          if-no-files-found: warn
