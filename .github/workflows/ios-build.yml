name: Build iOS IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get dependencies
        working-directory: workout_tracker
        run: flutter pub get

      - name: Build iOS release (Flutter)
        working-directory: workout_tracker
        run: |
          # Flutter builds but we'll use the generated .app
          flutter build ios --release --no-codesign 2>&1 || true

      - name: Create export options plist
        working-directory: workout_tracker/ios
        run: |
          cat > ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>compileBitcode</key>
            <false/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
            <key>signingStyle</key>
            <string>automatic</string>
          </dict>
          </plist>
          EOF

      - name: Build with xcodebuild (simulator)
        working-directory: workout_tracker/ios
        run: |
          # Install pods first
          pod install --repo-update
          
          # Build for simulator (no signing required)
          xcodebuild build \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            -derivedDataPath build/DerivedData \
            | tee xcodebuild_sim.log
            
          echo "=== Simulator build complete ==="
          
      - name: Verify simulator build
        working-directory: workout_tracker/ios
        run: |
          APP_PATH=$(find build/DerivedData -name "Runner.app" -type d 2>/dev/null | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "Found: $APP_PATH"
            SIZE=$(du -sm "$APP_PATH" | cut -f1)
            echo "Size: ${SIZE}MB"
            ls -la "$APP_PATH"
            
            # Check for binary
            if [ -f "$APP_PATH/Runner" ]; then
              echo "âœ“ Binary exists!"
              file "$APP_PATH/Runner"
            fi
          fi

      - name: Create IPA for AltStore
        working-directory: workout_tracker/ios
        run: |
          # Find the simulator app
          SIM_APP=$(find build/DerivedData -path "*iphonesimulator*" -name "Runner.app" -type d 2>/dev/null | head -1)
          
          if [ -n "$SIM_APP" ] && [ -f "$SIM_APP/Runner" ]; then
            echo "Using simulator app: $SIM_APP"
            
            # Create Payload structure
            mkdir -p ../output/Payload
            cp -r "$SIM_APP" ../output/Payload/
            
            # AltStore can handle simulator binaries and will re-sign them
            cd ../output
            zip -r workout_tracker_simulator.ipa Payload -x "*.DS_Store"
            
            echo "=== IPA Created ==="
            ls -lh workout_tracker_simulator.ipa
            
            # Show contents
            unzip -l workout_tracker_simulator.ipa | head -30
          else
            echo "No valid simulator app found"
            find build -name "*.app" -type d 2>/dev/null
          fi
          
      - name: Upload IPA (Simulator build for AltStore)
        uses: actions/upload-artifact@v4
        with:
          name: workout-tracker-ipa-simulator
          path: workout_tracker/output/workout_tracker_simulator.ipa
          if-no-files-found: warn
          
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            workout_tracker/ios/xcodebuild*.log
          if-no-files-found: warn
